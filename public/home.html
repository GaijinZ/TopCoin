<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Page Query Form</title>
</head>
<body>
<h2>Search Crypto Assets</h2>
<label for="symbolInput">Search Symbol:</label>
<input id="symbolInput" type="text" autocomplete="off" placeholder="Start typing...">
<hr>
<label for="pageInput" style="display:none;" id="pageLabel">Page:</label>
<input id="pageInput" type="number" min="1" value="1" style="display:none;" required>
<label for="paginationInput" style="display:none;" id="paginationLabel">Pagination:</label>
<input id="paginationInput" type="number" min="1" value="10" style="display:none;" required>
<button id="submitBtn" style="display:none;">Submit</button>
<pre id="output"></pre>
<script>
    let ws;
    let searchTimeout;
    let symbolFound = false;

    function setupWebSocket() {
        ws = new WebSocket(`ws://${location.host}/coindesk`);

        ws.onopen = () => {
            console.log('WebSocket connected');
        };

        document.getElementById("submitBtn").addEventListener("click", () => {
            const symbol = document.getElementById("symbolInput").value.trim().toUpperCase();
            const pageVal = document.getElementById('pageInput').value;
            const paginationVal = document.getElementById('paginationInput').value;
            if (!pageVal || !paginationVal) {
                alert('Page and Pagination are required!');
                return;
            }
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    symbol: symbol,
                    page: parseInt(pageVal, 10),
                    pagination: parseInt(paginationVal, 10)
                }));
            }
        });

        ws.onmessage = (event) => {
            try {
                const data = JSON.parse(event.data);
                if (data.Data && data.Data.symbols) {
                    symbolFound = false;
                    document.getElementById('output').textContent = data.Data.symbols
                        .map(item => `${item.symbol} - ${item.name}`)
                        .join('\n');
                    document.getElementById('pageInput').style.display = 'none';
                    document.getElementById('paginationInput').style.display = 'none';
                    document.getElementById('pageLabel').style.display = 'none';
                    document.getElementById('paginationLabel').style.display = 'none';
                    document.getElementById('submitBtn').style.display = 'none';
                } else {
                    symbolFound = true;
                    document.getElementById('output').textContent = JSON.stringify(data, null, 2);
                    document.getElementById('pageInput').style.display = '';
                    document.getElementById('paginationInput').style.display = '';
                    document.getElementById('pageLabel').style.display = '';
                    document.getElementById('paginationLabel').style.display = '';
                    document.getElementById('submitBtn').style.display = '';
                }
            } catch (e) {
                console.log("Invalid JSON from server:", event.data);
            }
        };
    }

    function debounceSend(symbol) {
        if (searchTimeout) clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    symbol: symbol
                }));
            }
        }, 2000);
    }

    document.getElementById("symbolInput").addEventListener("input", (e) => {
        const symbol = e.target.value.trim().toUpperCase();
        debounceSend(symbol);
    });

    window.onload = () => {
        setupWebSocket();
    };
</script>
</body>
</html>
